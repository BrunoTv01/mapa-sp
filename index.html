<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA RTV SP - GEST√ÉO UNIFICADA</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --verde: #009541; --amarelo: #f1c40f; --azul: #2980b9; --dark: #2c3e50; --bg: #f4f7f6; }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        #map { flex-grow: 1; height: 100%; z-index: 1; background: #e0e0e0; }
        
        .painel { width: 360px; height: 100%; background: white; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1000; }
        .header-painel { background: var(--dark); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--verde); }
        .header-painel h2 { margin: 0; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; }

        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; background: #ebedef; }
        .stat-card { text-align: center; padding: 8px 5px; border-radius: 4px; color: white; }
        .stat-num { display: block; font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 9px; text-transform: uppercase; font-weight: bold; }

        .busca-container { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; }
        #busca-cidade { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 6px; box-sizing: border-box; outline: none; }
        .btn-reset { width: 100%; margin-top: 10px; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }

        .conteudo-painel { padding: 20px; flex-grow: 1; overflow-y: auto; }
        .cidade-nome { font-size: 20px; font-weight: 800; color: var(--dark); text-transform: uppercase; margin-bottom: 15px; border-bottom: 3px solid var(--verde); display: block; }
        
        .info-box { padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 5px solid #ccc; background: #f9fafb; font-size: 13px; }
        .box-verde { border-left-color: var(--verde); background: #f0fff4; }
        .box-amarelo { border-left-color: var(--amarelo); background: #fffdf0; }

        .legenda { position: absolute; bottom: 30px; left: 20px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; font-size: 11px; }
        .legenda-item { display: flex; align-items: center; margin-bottom: 6px; }
        .cor-box { width: 14px; height: 14px; border-radius: 3px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); }
        
        .label-canal { background: var(--azul); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; border: 1px solid white; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="legenda">
    <div class="legenda-item"><div class="cor-box" style="background: var(--verde)"></div> Esta√ß√£o Transmissora</div>
    <div class="legenda-item"><div class="cor-box" style="background: var(--amarelo)"></div>Cobertura</div>
    <div class="legenda-item"><div class="cor-box" style="background: var(--azul)"></div> Fluxo / Enlace</div>
</div>

<div class="painel">
    <div class="header-painel"><h2>SISTEMA RTV SP</h2></div>
    <div class="stats-container">
        <div class="stat-card" style="background: var(--verde)"><span class="stat-num" id="count-verde">0</span><span class="stat-label">Esta√ß√µes</span></div>
        <div class="stat-card" style="background: var(--amarelo); color: #7f6000;"><span class="stat-num" id="count-amarelo">0</span><span class="stat-label">Cidades Corbertas</span></div>
    </div>
    <div class="busca-container">
        <input type="text" id="busca-cidade" placeholder="üîç Buscar munic√≠pio...">
        <button id="btn-reset" class="btn-reset" onclick="resetarMapa()">‚úñ LIMPAR SELE√á√ÉO</button>
    </div>
    <div class="conteudo-painel" id="painel-info">
        <div style="text-align: center; color: #94a3b8; margin-top: 50%;">Selecione um munic√≠pio no mapa.</div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>

<script>
    // --- BANCO DE DADOS √öNICO ---
const dbRTV = {
  "Adamantina": { f: "38", v: "4.4", m: "16QAM", fistel: "50410611220" },
  "√Åguas da Prata": { f: "36", v: "39.4", m: "16QAM", fistel: "50408694874" },
  "√Åguas de Lind√≥ia": { f: "38", v: "10.4", m: "16QAM", fistel: "50408113901" },
  "√Åguas de Santa B√°rbara": { f: "30", v: "3.4", m: "16QAM", fistel: "50412370859" },
  "Altin√≥polis": { f: "30", v: "4.4", m: "16QAM", fistel: "50409996408" },
  "Alum√≠nio": { f: "41", v: "41.4", m: "16QAM", fistel: "50408062134" },
  "Amparo": { f: "38", v: "10.4", m: "16QAM", fistel: "50409573515" },
  "Andradina": { f: "38", v: "5.4", m: "16QAM", fistel: "50409823805" },
  "Angatuba": { f: "42", v: "19.4", m: "16QAM", fistel: "50410493600" },
  "Apia√≠": { f: "30", v: "3.4", m: "16QAM", fistel: "50411205609" },
  "Ara√ßatuba": { f: "30", v: "4.4", m: "16QAM", fistel: "50410611301" },
  "Araraquara": { f: "34", v: "11.4", m: "16QAM", fistel: "50410326968" },
  "Araras": { f: "36", v: "19.4", m: "16QAM", fistel: "50410493783" },
  "Arealva": { f: "30", v: "5.4", m: "16QAM", fistel: "50410611492" },
  "Areias": { f: "50", v: "27.4", m: "16QAM", fistel: "50411746448" },
  "Assis": { f: "44", v: "13.4", m: "16QAM", fistel: "50409541745" },
  "Atibaia": {f:"24", v:"2.4", m:"16QAM", sfn: "S√£o Paulo"},
  "Avar√©": { f: "30", v: "3.4", m: "16QAM", fistel: "50409321036" },
  "Bananal": { f: "50", v: "27.4", m: "16QAM", fistel: "50411746529" },
  "Bar√£o de Antonina": { f: "30", v: "3.4", m: "16QAM", fistel: "50417050380" },
  "Bariri": { f: "44", v: "41.4", m: "16QAM", fistel: "50411144049" },
  "Barra Bonita": { f: "36", v: "19.4", m: "16QAM", fistel: "50412786010" },
  "Barra do Turvo": { f: "21", v: "3.4", m: "16QAM", fistel: "50409573604" },
  "Barretos": { f: "34", v: "12.4", m: "16QAM", fistel: "50410493864" },
  "Bastos": { f: "38", v: "4.4", m: "16QAM", fistel: "50410972320" },
  "Batatais": { f: "30", v: "4.4", m: "16QAM", fistel: "50409823996" },
  "Bauru": { f: "30", v: "5.4", m: "16QAM", fistel: "50409320900" },
  "Bebedouro": { f: "34", v: "12.4", m: "16QAM", fistel: "50411146254" },
  "Borborema": { f: "30", v: "4.4", m: "16QAM", fistel: "50410327000" },
  "Botucatu": { f: "36", v: "19.4", m: "16QAM", fistel: "50412662396" },
  "Bragan√ßa Paulista": { f: "24", v: "2.4", m: "16QAM", fistel: "50413327540" },
  "Brotas": { f: "36", v: "19.4", m: "16QAM", fistel: "50409996580" },
  "Buritizal": { f: "30", v: "4.4", m: "16QAM", fistel: "50412473747" },
  "Caconde": { f: "30", v: "4.4", m: "16QAM", fistel: "50409705284" },
  "Cafel√¢ndia": { f: "44", v: "13.4", m: "16QAM", fistel: "50410327182" },
  "Cajati": { f: "21", v: "3.4", m: "16QAM", fistel: "50409494992" },
  "Campinas": { f: "38", v: "10.4", m: "16QAM", fistel: "50409158453" },
  "Campos do Jord√£o": { f: "24", v: "8.4", m: "16QAM", fistel: "50409953857" },
  "Canan√©ia": { f: "21", v: "3.4", m: "16QAM", fistel: "50410327263" },
  "Cap√£o Bonito": { f: "30", v: "3.4", m: "16QAM", fistel: "50409824020" },
  "Capivari": { f: "38", v: "10.4", m: "16QAM", fistel: "50411206338" },
  "Caraguatatuba": { f: "21", v: "3.4", m: "16QAM", fistel: "50409573787" },
  "Cardoso": { f: "30", v: "4.4", m: "16QAM", fistel: "50409996661" },
  "C√°ssia dos Coqueiros": { f: "30", v: "4.4", m: "16QAM", fistel: "50409953938" },
  "Catanduva": { f: "30", v: "4.4", m: "16QAM", fistel: "50409495026" },
  "Cerqueira C√©sar": { f: "30", v: "3.4", m: "16QAM", fistel: "50412492296" },
  "Clementina": { f: "30", v: "4.4", m: "16QAM", fistel: "50410611573" },
  "Descalvado": { f: "30", v: "4.4", m: "16QAM", fistel: "50409493910" },
  "Dois C√≥rregos": { f: "36", v: "19.4", m: "16QAM", fistel: "50409495883" },
  "Dracena": { f: "39", v: "4.4", m: "16QAM", fistel: "50410493945" },
  "Duartina": { f: "44", v: "13.4", m: "16QAM", fistel: "50411145878" },
  "Eldorado": { f: "21", v: "3.4", m: "16QAM", fistel: "50409710440" },
  "Esp√≠rito Santo do Pinhal": { f: "38", v: "10.4", m: "16QAM", fistel: "50409987590" },
  "Estrela D'Oeste": { f: "30", v: "4.4", m: "16QAM", fistel: "50410611654" },
  "Fernand√≥polis": { f: "30", v: "4.4", m: "16QAM", fistel: "50410611735" },
  "Franca": { f: "30", v: "4.4", m: "16QAM", fistel: "50409160512" },
  "Gar√ßa": { f: "44", v: "13.4", m: "16QAM", fistel: "50410972401" },
  "General Salgado": { f: "30", v: "4.4", m: "16QAM", fistel: "50411145606" },
  "Gua√≠ra": { f: "30", v: "4.4", m: "16QAM", fistel: "50409494054" },
  "Guapiara": { f: "30", v: "3.4", m: "16QAM", fistel: "50409996742" },
  "Guararema": { f: "50", v: "55.4", m: "16QAM", fistel: "50410611816" },
  "Guaratinguet√°": { f: "50", v: "38.4", m: "16QAM", fistel: "50410327344" },
  "Guariba": { f: "30", v: "4.4", m: "16QAM", fistel: "50409495107" },
  "Iacanga": { f: "30", v: "5.4", m: "16QAM", fistel: "50411138901" },
  "Ibitinga": { f: "30", v: "4.4", m: "16QAM", fistel: "50410327425" },
  "Ic√©m": { f: "30", v: "4.4", m: "16QAM", fistel: "50410494089" },
  "Iep√™": { f: "39", v: "22.4", m: "16QAM", fistel: "50414387066" },
  "Igarapava": { f: "30", v: "4.4", m: "16QAM", fistel: "50409495298" },
  "Iguape": { f: "21", v: "3.4", m: "16QAM", fistel: "50409996823" },
  "Ilha Solteira": { f: "38", v: "5.4", m: "16QAM", fistel: "50409987670" },
  "Iper√≥": { f: "36", v: "14.4", m: "16QAM", fistel: "50410494160" },
  "Iporanga": { f: "21", v: "3.4", m: "16QAM", fistel: "50410494240" },
  "Itaber√°": { f: "30", v: "3.4", m: "16QAM", fistel: "50409615021" },
  "Ita√≠": { f: "30", v: "3.4", m: "16QAM", fistel: "50417098154" },
  "Itajobi": { f: "30", v: "4.4", m: "16QAM", fistel: "50410327506" },
  "Itanha√©m": { f: "43", v: "44.4", m: "16QAM", fistel: "50409162647" },
  "Itapetininga": { f: "42", v: "20.4", m: "16QAM", fistel: "50409162566" },
  "Itapira": { f: "38", v: "10.4", m: "16QAM", fistel: "50414386922" },
  "It√°polis": { f: "30", v: "4.4", m: "16QAM", fistel: "50409494135" },
  "Itaporanga": { f: "30", v: "3.4", m: "16QAM", fistel: "50409573868" },
  "Itarar√©": { f: "30", v: "3.4", m: "16QAM", fistel: "50409495379" },
  "Itariri": { f: "21", v: "3.4", m: "16QAM", fistel: "50409615102" },
  "Itatiba": { f: "24", v: "2.4", m: "16QAM", fistel: "50414850203" },
  "Itatinga": { f: "44", v: "47.4", m: "16QAM", fistel: "50409284599" },
  "Itu": {f:"41", v:"41.4", m:"16QAM", fistel:"50415971039", sfn: "Sorocaba"},
  "Ituverava": { f: "30", v: "4.4", m: "16QAM", fistel: "50410327697" },
  "Jaboticabal": { f: "30", v: "4.4", m: "16QAM", fistel: "50409495964" },
  "Jales": { f: "30", v: "4.4", m: "16QAM", fistel: "50409494216" },
  "Jaragu√°": { f: "24", v: "2.1", m: "64QAM", fistel: "50410612100" },
  "Ja√∫": { f: "44", v: "41.4", m: "16QAM", fistel: "50409168505" },
  "Jos√© Bonif√°cio": { f: "30", v: "4.4", m: "16QAM", fistel: "50409955981" },
 "Jundia√≠": {f:"24", v:"2.4", m:"16QAM", sfn: "S√£o Paulo"},
  "Junqueir√≥polis": { f: "39", v: "4.4", m: "16QAM", fistel: "50410972592" },
  "Juqui√°": { f: "21", v: "3.4", m: "16QAM", fistel: "50410494402" },
  "Juquitiba": { f: "21", v: "3.4", m: "16QAM", fistel: "50410327778" },
  "Lagoinha": { f: "50", v: "27.4", m: "16QAM", fistel: "50409954071" },
  "Laranjal Paulista": { f: "42", v: "20.4", m: "16QAM", fistel: "50409996904" },
  "Leme": { f: "30", v: "30.4", m: "16QAM", fistel: "50409162213" },
  "Len√ß√≥is Paulista": { f: "36", v: "19.4", m: "16QAM", fistel: "50412974100" },
  "Lind√≥ia": { f: "38", v: "10.4", m: "16QAM", fistel: "50410494674" },
  "Lins": { f: "44", v: "13.4", m: "16QAM", fistel: "50409824291" },
  "Mairipor√£": { f: "24", v: "2.4", m: "16QAM", fistel: "50411167170" },
  "Mar√≠lia": { f: "44", v: "13.4", m: "16QAM", fistel: "50409321117" },
  "Mat√£o": { f: "34", v: "11.4", m: "16QAM", fistel: "50409496006" },
  "Miracatu": { f: "21", v: "3.4", m: "16QAM", fistel: "50409574163" },
  "Mirand√≥polis": { f: "38", v: "5.4", m: "16QAM", fistel: "50410327859" },
  "Mococa": { f: "30", v: "4.4", m: "16QAM", fistel: "50409573949" },
  "Mogi das Cruzes": { f: "24", v: "2.1", m: "64QAM", fistel: "50410611905",sfn:"S√£o Paulo" },
  "Mongagu√°": { f: "43", v: "44.4", m: "16QAM", fistel: "50409496189" },
  "Monte Alegre do Sul": { f: "38", v: "10.4", m: "16QAM", fistel: "50410612111" },
  "Monte Alto": { f: "30", v: "4.4", m: "16QAM", fistel: "50410494755" },
  "Monte Apraz√≠vel": { f: "30", v: "4.4", m: "16QAM", fistel: "50409954152" },
  "Monteiro Lobato": { f: "50", v: "27.4", m: "16QAM", fistel: "50409954233" },
  "Morungaba": { f: "38", v: "10.4", m: "16QAM", fistel: "50409954314" },
  "Nhandeara": { f: "30", v: "4.4", m: "16QAM", fistel: "50411146173" },
  "Nova Europa": { f: "30", v: "4.4", m: "16QAM", fistel: "50409954403" },
  "Novo Horizonte": { f: "30", v: "4.4", m: "16QAM", fistel: "50409824372" },
  "Ol√≠mpia": { f: "30", v: "4.4", m: "16QAM", fistel: "50409494305" },
  "Orindi√∫va": { f: "30", v: "4.4", m: "16QAM", fistel: "50411145797" },
  "Orl√¢ndia": { f: "30", v: "4.4", m: "16QAM", fistel: "50409496260" },
  "Osvaldo Cruz": { f: "38", v: "4.4", m: "16QAM", fistel: "50409615293" },
  "Ourinhos": { f: "44", v: "13.4", m: "16QAM", fistel: "50411146688" },
  "Pacaembu": { f: "39", v: "22.4", m: "16QAM", fistel: "50416557155" },
  "Palestina": { f: "30", v: "4.4", m: "16QAM", fistel: "50411982680" },
  "Paraibuna": { f: "50", v: "27.4", m: "16QAM", fistel: "50411098187" },
  "Paranapanema": { f: "44", v: "47.4", m: "16QAM", fistel: "50411145959" },
  "Parapu√£": { f: "38", v: "4.4", m: "16QAM", fistel: "50409987751" },
  "Pariquera-A√ßu": { f: "21", v: "3.4", m: "16QAM", fistel: "50410494836" },
  "Patroc√≠nio Paulista": { f: "30", v: "4.4", m: "16QAM", fistel: "50414363205" },
  "Paulo de Faria": { f: "30", v: "4.4", m: "16QAM", fistel: "50410494917" },
  "Pederneiras": { f: "44", v: "41.4", m: "16QAM", fistel: "50409494488" },
  "Pedreira": { f: "38", v: "10.4", m: "16QAM", fistel: "50409158453" },
  "Pedro de Toledo": { f: "21", v: "3.4", m: "16QAM", fistel: "50410094226" },
  "Pen√°polis": { f: "30", v: "4.4", m: "16QAM", fistel: "50409987832" },
  "Pereira Barreto": { f: "38", v: "5.4", m: "16QAM", fistel: "50409496340" },
  "Pereiras": { f: "42", v: "20.4", m: "16QAM", fistel: "50409997048" },
  "Peru√≠be": { f: "43", v: "44.4", m: "16QAM", fistel: "50414387147" },
  "Piedade": { f: "41", v: "41.4", m: "16QAM", fistel: "50415945542" },
  "Pilar do Sul": { f: "42", v: "3.4", m: "16QAM", fistel: "50409496421" },
  "Pindorama": { f: "30", v: "4.4", m: "16QAM", fistel: "50414386841" },
  "Piracaia": { f: "24", v: "2.4", m: "16QAM", fistel: "50417030002" },
  "Piracicaba": { f: "36", v: "19.4", m: "16QAM", fistel: "50409159930" },
  "Piraju": { f: "44", v: "13.4", m: "16QAM", fistel: "50409824453" },
  "Piraju√≠": { f: "44", v: "13.4", m: "16QAM", fistel: "50412619202" },
  "Ponga√≠": { f: "30", v: "4.4", m: "16QAM", fistel: "50409997129" },
  "Pontes Gestal": { f: "30", v: "4.4", m: "16QAM", fistel: "50410327930" },
  "Porto Feliz": { f: "36", v: "14.4", m: "16QAM", fistel: "50411146505" },
  "Praia Grande": { f: "21", v: "3.4", m: "16QAM", fistel: "50409160270" },
  "Presidente Epit√°cio": { f: "38", v: "21.4", m: "16QAM", fistel: "50410328073" },
  "Presidente Prudente": { f: "39", v: "22.4", m: "16QAM", fistel: "50409494569" },
  "Presidente Venceslau": { f: "39", v: "22.4", m: "16QAM", fistel: "50409987913" },
  "Quat√°": { f: "38", v: "4.4", m: "16QAM", fistel: "50409710520" },
  "Queluz": { f: "50", v: "27.4", m: "16QAM", fistel: "50409615374" },
  "Rancharia": { f: "39", v: "22.4", m: "16QAM", fistel: "50409495450" },
  "Regin√≥polis": { f: "30", v: "5.4", m: "16QAM", fistel: "50409708623" },
  "Registro": { f: "21", v: "3.4", m: "16QAM", fistel: "50409496855" },
  "Ribeira": { f: "30", v: "3.4", m: "16QAM", fistel: "50409615455" },
  "Ribeir√£o Bonito": { f: "34", v: "11.4", m: "16QAM", fistel: "50409954586" },
  "Ribeir√£o Branco": { f: "30", v: "3.4", m: "16QAM", fistel: "50409956600" },
  "Ribeir√£o Preto": { f: "30", v: "4.4", m: "16QAM", fistel: "50410328154" },
  "Rifaina": { f: "30", v: "4.4", m: "16QAM", fistel: "50411139045" },
  "Rin√≥polis": { f: "39", v: "39.4", m: "16QAM", fistel: "50417324421" },
  "Rio Claro": { f: "34", v: "35.4", m: "16QAM", fistel: "50409824534" },
  "Riol√¢ndia": { f: "30", v: "4.4", m: "16QAM", fistel: "50410612200" },
  "Riversul": { f: "30", v: "3.4", m: "16QAM", fistel: "50416946135" },
  "Salto": { f: "36", v: "41.4", m: "16QAM", fistel: "50409162485", sfn: "Sorocaba" },
  "Sandovalina": { f: "38", v: "39.4", m: "16QAM", fistel: "50411988379" },
  "Santa Ad√©lia": { f: "30", v: "4.4", m: "16QAM", fistel: "50412089807" },
  "Santa B√°rbara d'Oeste": { f: "38", v: "10.4", m: "16QAM", fistel: "50413386805" },
  "Santa Cruz das Palmeiras": { f: "30", v: "30.4", m: "16QAM", fistel: "50409956015" },
  "Santa Cruz do Rio Pardo": { f: "44", v: "13.4", m: "16QAM", fistel: "50409495530" },
  "Santa F√© do Sul": { f: "30", v: "4.4", m: "16QAM", fistel: "50409496502" },
  "Santa Isabel": { f: "24", v: "2.1", m: "64QAM", fistel: "50410612000",sfn: "S√£o Paulo" },
  "Santa Maria da Serra": { f: "36", v: "2.4", m: "16QAM", fistel: "50412520176" },
  "Santa Rita do Passa Quatro": { f: "30", v: "30.4", m: "16QAM", fistel: "50409496693" },
  "Santos": { f: "21", v: "3.4", m: "16QAM", fistel: "50409269956" },
  "S√£o Bento do Sapuca√≠": { f: "50", v: "27.4", m: "16QAM", fistel: "50411203584" },
  "S√£o Carlos": { f: "34", v: "11.4", m: "16QAM", fistel: "50409164003" },
  "S√£o Jo√£o da Boa Vista": { f: "38", v: "10.4", m: "16QAM", fistel: "50410612383" },
  "S√£o Joaquim da Barra": { f: "30", v: "4.4", m: "16QAM", fistel: "50409496936" },
  "S√£o Jos√© do Barreiro": { f: "50", v: "27.4", m: "16QAM", fistel: "50409855090" },
  "S√£o Jos√© do Rio Pardo": { f: "30", v: "4.4", m: "16QAM", fistel: "50409988057" },
  "S√£o Jos√© do Rio Preto": { f: "30", v: "4.4", m: "16QAM", fistel: "50409163880" },
  "S√£o Jos√© dos Campos": { f: "50", v: "27.4", m: "16QAM", fistel: "50409168335" },
  "S√£o Lu√≠s do Paraitinga": { f: "50", v: "27.4", m: "16QAM", fistel: "50409615536" },
  "S√£o Manuel": { f: "36", v: "19.4", m: "16QAM", fistel: "50413364232" },
  "S√£o Miguel Arcanjo": { f: "42", v: "3.4", m: "16QAM", fistel: "50409496774" },
  "S√£o Paulo": { f: "24", v: "2.1", m: "64QAM", fistel: "50403102453" },
  "S√£o Pedro": { f: "36", v: "19.4", m: "16QAM", fistel: "50409824615" },
  "S√£o Roque": { f: "41", v: "41.4", m: "16QAM", fistel: "50410328316" },
  "Serra Negra": { f: "38", v: "10.4", m: "16QAM", fistel: "50414887034" },
  "Sert√£ozinho": { f: "30", v: "4.4", m: "16QAM", fistel: "50409174904" },
  "Sete Barras": { f: "21", v: "3.4", m: "16QAM", fistel: "50409615617" },
  "Silveiras": { f: "50", v: "27.4", m: "16QAM", fistel: "50409615706" },
  "Socorro": { f: "38", v: "10.4", m: "16QAM", fistel: "50409954667" },
  "Sorocaba": { f: "41", v: "41.4", m: "16QAM", fistel: "50409163961" },
  "Tabapu√£": { f: "30", v: "4.4", m: "16QAM", fistel: "50409710601" },
  "Tanabi": { f: "30", v: "4.4", m: "16QAM", fistel: "50409574082" },
  "Tapira√≠": { f: "42", v: "20.4", m: "16QAM", fistel: "50409997390" },
  "Taquaritinga": { f: "30", v: "4.4", m: "16QAM", fistel: "50413361870" },
  "Taquarituba": { f: "30", v: "3.4", m: "16QAM", fistel: "50410328405" },
  "Taubat√©": { f: "24", v: "8.4", m: "16QAM", fistel: "50409162051" },
  "Teodoro Sampaio": { f: "39", v: "22.4", m: "16QAM", fistel: "50409824704" },
  "Terra Roxa": { f: "30", v: "4.4", m: "16QAM", fistel: "50411987992" },
  "Torrinha": { f: "36", v: "2.4", m: "16QAM", fistel: "50412520176" },
  "Tup√£": { f: "38", v: "4.4", m: "16QAM", fistel: "50409495611" },
  "Ubatuba": { f: "21", v: "3.4", m: "16QAM", fistel: "50409956791" },
  "Valpara√≠so": { f: "30", v: "4.4", m: "16QAM", fistel: "50409956104" },
  "Votorantim": { f: "41", v: "41.4", m: "16QAM", fistel: "50414363396", sfn: "Sorocaba" },
  "Votuporanga": { f: "30", v: "4.4", m: "16QAM", fistel: "50409163708" },

  // Cidades que n√£o possuim esta√ß√£o retransmissora.     

        "Ara√ßoiaba da Serra": {sfn: "Sorocaba"}, 
        "Valinhos": {sfn: "Campinas"},
        "Franco da Rocha":{sfn: "S√£o Paulo"},
        "Cajamar":{sfn: "S√£o Paulo"},
        "Caieiras":{sfn: "S√£o Paulo"},
        "Guarulhos":{sfn: "S√£o Paulo"},
        "S√£o Caetano do Sul":{sfn: "S√£o Paulo"},
        "Diadema":{sfn: "S√£o Paulo"},
        "S√£o Bernardo do Campo":{sfn: "S√£o Paulo"},
        "Mau√°":{sfn: "S√£o Paulo"},
        "Santo Andr√©":{sfn: "S√£o Paulo"},
        "Aruj√°":{sfn: "S√£o Paulo"},
        "Ferraz de Vasconcelos":{sfn: "S√£o Paulo"},
        "Suzano":{sfn: "S√£o Paulo"},
        "Rio Grande da Serra":{sfn: "S√£o Paulo"},
        "Po√°":{sfn: "S√£o Paulo"},
 
    };

    const map = L.map('map').setView([-23.5, -46.6], 8);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

    let geojsonLayer, camadaAtiva = null;
    let grupoLinhas = L.layerGroup().addTo(map);

    function estiloMapa(feature) {
        const nome = feature.properties.name;
        const info = dbRTV[nome];
        let corFinal = "#d1d5db", opacidade = 0.2;
        
        if (info) {
            corFinal = info.f ? "#009541" : "#f1c40f";
            opacidade = 0.7;
        }

        if (camadaAtiva) {
            const nomeFoco = camadaAtiva.feature.properties.name;
            const redeSede = dbRTV[nomeFoco]?.sfn || nomeFoco;
            // Destaca a rede: ou √© a sede, ou √© filha dessa sede
            const pertence = (nome === redeSede) || (dbRTV[nome]?.sfn === redeSede);
            opacidade = pertence ? 0.9 : 0.05;
        }
        return { fillColor: corFinal, fillOpacity: opacidade, color: "white", weight: 1 };
    }

    function desenharFluxo(nome) {
        grupoLinhas.clearLayers();
        const info = dbRTV[nome];
        const redeSede = info?.sfn || nome;
        
        let sedeLayer, filhasLayers = [];
        
        // Localiza as camadas da rede
        geojsonLayer.eachLayer(l => {
            if (l.feature.properties.name === redeSede) sedeLayer = l;
            if (dbRTV[l.feature.properties.name]?.sfn === redeSede) filhasLayers.push(l);
        });

        if (sedeLayer && filhasLayers.length > 0) {
            const pSede = sedeLayer.getBounds().getCenter();
            const canal = dbRTV[redeSede]?.f || "Digital";

            filhasLayers.forEach(fLayer => {
                const pFilha = fLayer.getBounds().getCenter();
                
                // 1. Linha de Enlace
                const linha = L.polyline([pSede, pFilha], {
                    color: '#2980b9', weight: 2, dashArray: '5, 8'
                }).addTo(grupoLinhas);

                // 2. Seta Direcional
                L.polylineDecorator(linha, {
                    patterns: [{ offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({pixelSize: 10, pathOptions: {color: '#2980b9', fillOpacity: 1}}) }]
                }).addTo(grupoLinhas);

                // 3. Etiqueta de Canal (no meio da linha)
                const meio = [ (pSede.lat + pFilha.lat)/2, (pSede.lng + pFilha.lng)/2 ];
                L.marker(meio, {
                    icon: L.divIcon({
                        className: 'label-canal',
                        html: `CH ${canal}`,
                        iconSize: [45, 18]
                    })
                }).addTo(grupoLinhas);
            });
        }
    }

    function atualizarPainel(nome) {
        const info = dbRTV[nome];
        document.getElementById('btn-reset').style.display = 'block';
        let html = `<div class="cidade-nome">${nome}</div>`;
        
        if (info) {
            if (info.sfn) {
                html += `<div class="info-box box-amarelo">
                            <b>ORIGEM DO SINAL: ${info.sfn}</b><br>
                            Sincronizado via SFN com a sede.
                         </div>`;
            }
            if (info.f) {
                html += `<div class="info-box box-verde">
                            <b>ESTA√á√ÉO LOCAL:</b><br>
                            Canal F√≠sico: <b>${info.f}</b><br>
                            Canal Virtual: <b>${info.v || '---'}</b><br>
                            Fistel: <small>${info.fistel || 'N/A'}</small>
                         </div>`;
            }
        } else {
            html += `<div class="info-box">Munic√≠pio fora da √°rea de cobertura direta.</div>`;
        }
        document.getElementById('painel-info').innerHTML = html;
    }

    function resetarMapa() {
        camadaAtiva = null;
        grupoLinhas.clearLayers();
        geojsonLayer.setStyle(estiloMapa);
        map.setView([-23.5, -46.6], 8);
        document.getElementById('btn-reset').style.display = 'none';
        document.getElementById('busca-cidade').value = '';
        document.getElementById('painel-info').innerHTML = '<div style="text-align: center; color: #94a3b8; margin-top: 50%;">Selecione um munic√≠pio no mapa.</div>';
    }

    async function iniciar() {
        const res = await fetch('https://cdn.jsdelivr.net/gh/tbrugz/geodata-br/geojson/geojs-35-mun.json');
        const data = await res.json();
        
        geojsonLayer = L.geoJson(data, {
            style: estiloMapa,
            onEachFeature: (feature, layer) => {
                layer.on('click', () => {
                    camadaAtiva = layer;
                    geojsonLayer.setStyle(estiloMapa);
                    atualizarPainel(feature.properties.name);
                    desenharFluxo(feature.properties.name);
                    map.fitBounds(layer.getBounds(), {padding: [50, 50]});
                });
                layer.bindTooltip(feature.properties.name, {sticky: true});
            }
        }).addTo(map);

        // Atualiza contadores
        let estacoes = 0, sfn = 0;
        Object.values(dbRTV).forEach(c => { if(c.f) estacoes++; if(c.sfn) sfn++; });
        document.getElementById('count-verde').innerText = estacoes;
        document.getElementById('count-amarelo').innerText = sfn;
    }

    document.getElementById('busca-cidade').addEventListener('input', (e) => {
        const termo = e.target.value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        if(termo.length > 2) {
            geojsonLayer.eachLayer(l => {
                const nomeMapa = l.feature.properties.name.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if (nomeMapa === termo) l.fire('click');
            });
        }
    });

    iniciar();
</script>
</body>
</html>
